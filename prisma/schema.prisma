// SEOLOGY.AI - Complete Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Users & Authentication (managed by Clerk)
model User {
  id        String   @id @default(uuid())
  clerkId   String   @unique
  email     String   @unique
  name      String?
  plan      Plan     @default(STARTER)

  executionMode  ExecutionMode @default(AUTOMATIC)

  stripeCustomerId       String?
  stripeSubscriptionId   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  connections      Connection[]
  aiConversations  AIConversation[]
  auditLogs        AuditLog[]
  subscriptions    Subscription[]
  notifications    Notification[]
  webhooks         Webhook[]
  teamMemberships  TeamMember[]
  ownedTeams       Team[]             @relation("TeamOwner")
  sentInvitations  TeamInvitation[]   @relation("InvitationSender")
}

enum ExecutionMode {
  AUTOMATIC
  PLAN
  APPROVE
}

enum Plan {
  STARTER
  GROWTH
  SCALE
}

// Website Connections
model Connection {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  teamId      String?
  team        Team?    @relation("TeamConnections", fields: [teamId], references: [id], onDelete: SetNull)

  platform    Platform
  domain      String
  displayName String?

  // Encrypted credentials
  accessToken   String?
  refreshToken  String?
  credentials   String?  // JSON string of platform-specific data

  status      ConnectionStatus  @default(PENDING)
  lastSync    DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  issues      Issue[]
  fixes       Fix[]
  metrics     Metric[]
  crawls      Crawl[]

  @@index([userId])
  @@index([teamId])
}

enum Platform {
  SHOPIFY
  WORDPRESS
  WIX
  CUSTOM
}

enum ConnectionStatus {
  PENDING
  CONNECTED
  ERROR
  DISCONNECTED
}

// SEO Issues Detected
model Issue {
  id           String   @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  type         String   // 'missing_meta', 'broken_link', 'missing_alt', etc.
  title        String
  severity     Severity
  pageUrl      String
  details      String   // JSON string
  recommendation String? // AI-generated fix recommendation

  status       IssueStatus @default(DETECTED)

  detectedAt   DateTime @default(now())
  fixedAt      DateTime?
  createdAt    DateTime @default(now())

  // Relations
  fixes        Fix[]

  @@index([connectionId])
  @@index([status])
}

enum Severity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  FIXED
  FAILED
  IGNORED
  DETECTED
  FIXING
}

// Fixes Applied
model Fix {
  id           String   @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  issueId      String?
  issue        Issue?   @relation(fields: [issueId], references: [id])

  description  String
  type         String   @default("seo_fix")
  targetUrl    String?

  changes      String   // JSON string of the fix code/changes
  beforeState  String   @default("{}")  // JSON string
  afterState   String   @default("{}")  // JSON string

  method       FixMethod @default(AUTOMATIC)
  status       FixStatus @default(PENDING)

  appliedAt    DateTime?
  rolledBackAt DateTime?

  createdAt    DateTime @default(now())

  @@index([connectionId])
  @@index([status])
}

enum FixMethod {
  AUTOMATIC
  MANUAL
  PENDING
}

enum FixStatus {
  PENDING
  APPLIED
  ROLLED_BACK
  FAILED
}

// Performance Metrics
model Metric {
  id           String   @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  date         DateTime @default(now())

  organicTraffic Int?
  rankings       String?  // JSON string: {keyword: position}
  pageSpeed      Float?
  issuesCount    Int?
  fixesCount     Int?

  createdAt    DateTime @default(now())

  @@unique([connectionId, date])
  @@index([connectionId])
}

// AI Conversations
model AIConversation {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  connectionId String?

  messages     String   // JSON string array of {role, content}
  context      String?  // JSON string of site-specific context

  createdAt    DateTime @default(now())

  @@index([userId])
}

// Audit Logs
model AuditLog {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id])

  connectionId String?

  action       String
  resource     String?  // Type of resource ('fix', 'issue', 'plan', etc.)
  resourceId   String?  // ID of the resource
  details      String   @default("{}")  // JSON string
  ipAddress    String?
  userAgent    String?

  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

// Billing & Subscriptions
model Subscription {
  id                    String   @id @default(uuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  stripeSubscriptionId  String   @unique
  plan                  Plan
  status                SubscriptionStatus

  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime

  createdAt             DateTime @default(now())

  @@index([userId])
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  TRIALING
}

// Crawl Jobs
model Crawl {
  id           String   @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  status       CrawlStatus @default(PENDING)
  pagesFound   Int?
  issuesFound  Int?

  startedAt    DateTime?
  completedAt  DateTime?

  createdAt    DateTime @default(now())

  @@index([connectionId])
  @@index([status])
}

enum CrawlStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

// Notifications
model Notification {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  type         String   // 'SUCCESS', 'ERROR', 'INFO', 'WARNING'
  title        String
  message      String
  actionUrl    String?  // Optional link to relevant page

  read         Boolean  @default(false)

  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([read])
}

// Webhooks
model Webhook {
  id               String    @id @default(uuid())
  userId           String
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  url              String
  events           String    // JSON array of event types
  secret           String    // HMAC secret for signature verification
  enabled          Boolean   @default(true)

  failureCount     Int       @default(0)
  lastTriggeredAt  DateTime?

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([userId])
  @@index([enabled])
}

// Teams & Collaboration
model Team {
  id          String   @id @default(uuid())
  name        String
  description String?

  ownerId     String
  owner       User     @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  plan        Plan     @default(STARTER)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  members     TeamMember[]
  invitations TeamInvitation[]
  connections Connection[]     @relation("TeamConnections")

  @@index([ownerId])
}

model TeamMember {
  id          String   @id @default(uuid())
  teamId      String
  team        Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  role        TeamRole @default(MEMBER)

  joinedAt    DateTime @default(now())

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

model TeamInvitation {
  id          String           @id @default(uuid())
  teamId      String
  team        Team             @relation(fields: [teamId], references: [id], onDelete: Cascade)

  email       String
  role        TeamRole         @default(MEMBER)

  invitedBy   String
  inviter     User             @relation("InvitationSender", fields: [invitedBy], references: [id])

  status      InvitationStatus @default(PENDING)
  token       String           @unique

  expiresAt   DateTime
  acceptedAt  DateTime?

  createdAt   DateTime         @default(now())

  @@unique([teamId, email])
  @@index([teamId])
  @@index([email])
  @@index([token])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}
