// SEOLOGY.AI - Complete Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Users & Authentication (managed by Clerk)
model User {
  id      String  @id @default(uuid())
  clerkId String  @unique
  email   String  @unique
  name    String?
  plan    Plan    @default(STARTER)
  role    Role    @default(USER)

  executionMode ExecutionMode @default(AUTOMATIC)

  stripeCustomerId     String?
  stripeSubscriptionId String?

  // Daily Automation Settings
  dailyAutomationEnabled  Boolean   @default(false)
  dailyAutomationTime     String?   @default("09:00") // HH:MM format in user's timezone
  dailyAutomationTimezone String?   @default("UTC")
  dailyReportEmail        Boolean   @default(true) // Send email report
  dailyReportDashboard    Boolean   @default(true) // Send to dashboard inbox
  lastAutomationRun       DateTime?

  // Onboarding state
  onboardingCompleted Boolean @default(false)
  onboardingStep      Int     @default(0)
  businessType        String? // E-commerce, SaaS, Local Business
  businessName        String?
  businessStage       String? // Just Starting, Growing, Established
  platform            String? // Shopify, WordPress, WooCommerce, Custom

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  connections         Connection[]
  aiConversations     AIConversation[]
  auditLogs           AuditLog[]
  subscriptions       Subscription[]
  notifications       Notification[]
  webhooks            Webhook[]
  teamMemberships     TeamMember[]
  ownedTeams          Team[]               @relation("TeamOwner")
  sentInvitations     TeamInvitation[]     @relation("InvitationSender")
  usageRecords        UsageRecord[]
  aiCreditPurchases   AICreditPurchase[]
  pendingPlans        PendingPlan[]
  connectionRequests  ConnectionRequest[] // Customer's connection requests
  dailyReports        DailyReport[] // Daily automation reports
  automationSnapshots AutomationSnapshot[] // Intelligent rollback snapshots

  @@index([email])
  @@index([plan])
}

enum ExecutionMode {
  AUTOMATIC
  PLAN
  APPROVE
}

enum Role {
  USER
  ADMIN
}

enum Plan {
  STARTER
  GROWTH
  SCALE
}

// Website Connections
model Connection {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  teamId String?
  team   Team?   @relation("TeamConnections", fields: [teamId], references: [id], onDelete: SetNull)

  platform    Platform
  domain      String
  displayName String?

  // Encrypted credentials
  accessToken  String?
  refreshToken String?
  credentials  String? // JSON string of platform-specific data

  status   ConnectionStatus @default(PENDING)
  lastSync DateTime?

  // Health and statistics
  healthStatus   String    @default("unknown") // 'healthy', 'warning', 'error', 'unknown'
  pageCount      Int       @default(0)
  issueCount     Int       @default(0)
  lastCrawlAt    DateTime?
  lastAnalysisAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  issues             Issue[]
  fixes              Fix[]
  metrics            Metric[]
  crawls             Crawl[]
  pages              Page[] // Page-level SEO tracking
  keywords           Keyword[] // Keyword tracking
  aiInsights         AIInsight[] // AI-powered insights
  contentSuggestions ContentSuggestion[] // Content optimization
  healthScores       SiteHealthScore[] // Site health tracking
  imageAssets        ImageAsset[] // Image SEO tracking
  shopifyProducts    ShopifyProduct[] // Shopify products
  shopifyCollections ShopifyCollection[] // Shopify collections
  structuredData     StructuredData[] // Schema.org structured data
  metaTags           MetaTag[] // Meta tags management
  supportTickets     SupportTicket[] // Support tickets

  @@index([userId])
  @@index([teamId])
  @@index([platform])
  @@index([status])
  @@index([domain])
  // PERFORMANCE: Compound index for common query pattern (automation, overview)
  @@index([domain, platform, status])
}

enum Platform {
  SHOPIFY
  WORDPRESS
  WIX
  GITHUB
  CUSTOM
}

enum ConnectionStatus {
  PENDING
  CONNECTED
  ERROR
  DISCONNECTED
}

// SEO Issues Detected
model Issue {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  type           String // 'missing_meta', 'broken_link', 'missing_alt', etc.
  title          String
  severity       Severity
  pageUrl        String
  details        String // JSON string
  recommendation String? // AI-generated fix recommendation

  status IssueStatus @default(DETECTED)

  // Impact estimation
  impactScore      Float?  @default(0) // Estimated SEO impact (0-100)
  estimatedTraffic Int? // Estimated traffic impact per month
  elementSelector  String? // CSS selector for element

  detectedAt DateTime  @default(now())
  fixedAt    DateTime?
  createdAt  DateTime  @default(now())

  // Relations
  fixes Fix[]

  @@index([connectionId])
  @@index([status])
  @@index([severity])
  @@index([type])
  // PERFORMANCE: Compound index for N+1 query optimization (automation-engine.ts)
  @@index([connectionId, status, detectedAt])
}

enum Severity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  FIXED
  FAILED
  IGNORED
  DETECTED
  FIXING
}

// Fixes Applied
model Fix {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  issueId String?
  issue   Issue?  @relation(fields: [issueId], references: [id])

  description String
  type        String  @default("seo_fix")
  targetUrl   String?

  changes     String // JSON string of the fix code/changes
  beforeState String @default("{}") // JSON string
  afterState  String @default("{}") // JSON string

  method FixMethod @default(AUTOMATIC)
  status FixStatus @default(PENDING)

  appliedAt        DateTime?
  rolledBackAt     DateTime?
  rollbackDeadline DateTime? // appliedAt + 90 days

  // Impact tracking
  impactMetrics String  @default("{}") // JSON: actual vs. expected metrics
  platform      String? // Platform-specific implementation details

  // Plan association
  planId String?
  plan   PendingPlan? @relation(fields: [planId], references: [id])

  createdAt DateTime @default(now())

  @@index([connectionId])
  @@index([status])
  @@index([appliedAt])
  @@index([rollbackDeadline])
  @@index([planId])
  // PERFORMANCE: Compound index for fix queries by issue and status
  @@index([issueId, status])
}

enum FixMethod {
  AUTOMATIC
  MANUAL
  PENDING
}

enum FixStatus {
  PENDING
  APPLIED
  ROLLED_BACK
  FAILED
}

// Performance Metrics
model Metric {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  date DateTime @default(now())

  organicTraffic Int?
  rankings       String? // JSON string: {keyword: position}
  pageSpeed      Float?
  issuesCount    Int?
  fixesCount     Int?

  createdAt DateTime @default(now())

  @@unique([connectionId, date])
  @@index([connectionId])
  @@index([date])
}

// AI Conversations - Updated to support individual messages
model AIConversation {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  connectionId String?

  title      String? // Optional conversation title
  context    String? // JSON string of site-specific context
  isArchived Boolean @default(false)

  messages ChatMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, isArchived])
}

// Individual Chat Messages
model ChatMessage {
  id             String         @id @default(uuid())
  conversationId String
  conversation   AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role     String // 'user' or 'assistant'
  content  String  @db.Text // Use Text for longer messages
  metadata String? // JSON string for any additional data

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([conversationId, createdAt])
}

// Audit Logs
model AuditLog {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  connectionId String?

  action     String
  resource   String? // Type of resource ('fix', 'issue', 'plan', etc.)
  resourceId String? // ID of the resource
  details    String  @default("{}") // JSON string
  ipAddress  String?
  userAgent  String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([action])
  @@index([connectionId])
}

// Billing & Subscriptions
model Subscription {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  stripeSubscriptionId String             @unique
  plan                 Plan
  status               SubscriptionStatus

  currentPeriodStart DateTime
  currentPeriodEnd   DateTime

  trialEnd          DateTime?
  cancelAtPeriodEnd Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  TRIALING
}

// Crawl Jobs
model Crawl {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  status      CrawlStatus @default(PENDING)
  pagesFound  Int?
  issuesFound Int?

  startedAt   DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())

  @@index([connectionId])
  @@index([status])
}

enum CrawlStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

// Notifications
model Notification {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      String // 'SUCCESS', 'ERROR', 'INFO', 'WARNING'
  title     String
  message   String
  actionUrl String? // Optional link to relevant page
  icon      String? // Icon identifier
  color     String? // Color scheme

  read Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

// Webhooks
model Webhook {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  url     String
  events  String // JSON array of event types
  secret  String // HMAC secret for signature verification
  enabled Boolean @default(true)

  failureCount    Int       @default(0)
  lastTriggeredAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([enabled])
}

// Teams & Collaboration
model Team {
  id          String  @id @default(uuid())
  name        String
  description String?

  ownerId String
  owner   User   @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  plan Plan @default(STARTER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members     TeamMember[]
  invitations TeamInvitation[]
  connections Connection[]     @relation("TeamConnections")

  @@index([ownerId])
}

model TeamMember {
  id     String @id @default(uuid())
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  role TeamRole @default(MEMBER)

  joinedAt DateTime @default(now())

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

model TeamInvitation {
  id     String @id @default(uuid())
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  email String
  role  TeamRole @default(MEMBER)

  invitedBy String
  inviter   User   @relation("InvitationSender", fields: [invitedBy], references: [id])

  status InvitationStatus @default(PENDING)
  token  String           @unique

  expiresAt  DateTime
  acceptedAt DateTime?

  createdAt DateTime @default(now())

  @@unique([teamId, email])
  @@index([teamId])
  @@index([email])
  @@index([token])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// CSRF Protection for OAuth Flows
model CSRFToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  provider  String // SHOPIFY, WORDPRESS, GOOGLE
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

// Usage Tracking (Monthly quotas per plan)
model UsageRecord {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  period DateTime // First day of the month (e.g., 2024-01-01)

  // Usage counters
  sitesUsed      Int @default(0)
  fixesApplied   Int @default(0)
  crawlsExecuted Int @default(0)
  apiCallsMade   Int @default(0)
  aiCreditsUsed  Int @default(0) // AI chat messages used

  // Quota limits from plan (cached for historical accuracy)
  sitesLimit     Int
  fixesLimit     Int
  aiCreditsLimit Int // AI chat message limit

  // Flags
  overageOccurred   Boolean @default(false)
  limitWarningShown Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  apiUsage APIUsageLog[]

  @@unique([userId, period])
  @@index([userId])
  @@index([period])
}

// Detailed API Usage Tracking (for analytics dashboard)
model APIUsageLog {
  id     String @id @default(uuid())
  userId String

  usageRecordId String?
  usageRecord   UsageRecord? @relation(fields: [usageRecordId], references: [id], onDelete: SetNull)

  // API call details
  model          String // 'claude-3-5-sonnet-20241022', etc.
  endpoint       String // 'analyze', 'fix', 'chat', etc.

  // Token tracking
  inputTokens    Int    @default(0)
  outputTokens   Int    @default(0)
  totalTokens    Int    @default(0)

  // Cost tracking (in USD)
  inputCost      Float  @default(0)
  outputCost     Float  @default(0)
  totalCost      Float  @default(0)

  // Context
  shop           String? // Shopify domain
  connectionId   String? // Connection ID
  fixType        String? // Type of fix applied
  resourceType   String? // 'product', 'collection', 'image', etc.
  resourceId     String? // ID of resource analyzed/fixed

  // Performance
  latencyMs      Int?    // API call latency
  cached         Boolean @default(false)

  // Status
  status         String  @default("success") // 'success', 'error', 'timeout'
  errorMessage   String?

  timestamp      DateTime @default(now())

  @@index([userId])
  @@index([timestamp])
  @@index([model])
  @@index([endpoint])
  @@index([shop])
  @@index([connectionId])
  // Compound index for analytics queries
  @@index([userId, timestamp])
  @@index([shop, timestamp])
}

// AI Credit Purchases (One-time credit purchases)
model AICreditPurchase {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Purchase details
  creditsAmount   Int // Number of credits purchased
  pricePerCredit  Float // Price per credit in USD
  totalPrice      Float // Total price paid
  stripePaymentId String? // Stripe payment intent ID

  // Credits tracking
  creditsRemaining Int // Credits left from this purchase
  creditsUsed      Int       @default(0) // Credits consumed
  expiresAt        DateTime? // Optional expiry date

  // Status
  status PurchaseStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([expiresAt])
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// Job Queue System (for background tasks)
model Job {
  id String @id @default(uuid())

  type     JobType // Type of job to execute
  status   JobStatus @default(PENDING)
  priority Int       @default(5) // 1=highest, 10=lowest

  // Job data
  payload String // JSON string of input data
  result  String? // JSON string of output data
  error   String? // Error message if failed

  // Execution tracking
  attempts            Int       @default(0)
  maxAttempts         Int       @default(3)
  progress            Float     @default(0) // 0-100 percentage
  estimatedCompletion DateTime? // Estimated completion time

  // Scheduling
  scheduledFor DateTime  @default(now())
  startedAt    DateTime?
  completedAt  DateTime?
  failedAt     DateTime?

  // Relations (optional)
  connectionId String?
  userId       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([scheduledFor])
  @@index([priority])
  @@index([type])
  @@index([connectionId])
  @@index([userId])
  // PERFORMANCE: Compound index for job queue processing
  @@index([status, scheduledFor, priority])
}

enum JobType {
  CRAWL_SITE
  ANALYZE_SITE
  APPLY_FIX
  ROLLBACK_FIX
  CLEANUP_ROLLBACKS
  RESET_USAGE
  SYNC_METRICS
  GENERATE_REPORT
  SCAN_IMAGES
  OPTIMIZE_IMAGES
  DAILY_AUTOMATION
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  RETRYING
}

// Pending Plans (for PLAN execution mode)
model PendingPlan {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  connectionId String

  // Plan details
  title           String
  description     String
  estimatedImpact String @default("{}") // JSON: expected improvements

  status PlanStatus @default(PENDING)

  // Approval tracking
  approvedAt      DateTime?
  rejectedAt      DateTime?
  executedAt      DateTime?
  rejectionReason String?

  // Relations
  fixes Fix[] // All fixes in this plan

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([connectionId])
  @@index([status])
  @@index([createdAt])
}

enum PlanStatus {
  PENDING
  APPROVED
  REJECTED
  EXECUTING
  COMPLETED
  FAILED
}

// Broadcast Messages (Admin feature)
model Broadcast {
  id String @id @default(uuid())

  // Message content
  type        String // 'INFO', 'SUCCESS', 'WARNING', 'ERROR'
  title       String
  message     String
  richMessage String? // HTML content from rich editor
  actionUrl   String? // Optional CTA link
  actionText  String? // CTA button text

  // Targeting
  targetAudience String @default("all") // 'all', 'plan', 'role', 'custom'
  targetPlans    String @default("[]") // JSON array of plan names
  targetRoles    String @default("[]") // JSON array of roles
  targetUserIds  String @default("[]") // JSON array of specific user IDs

  // Scheduling
  scheduledFor    DateTime?
  sendImmediately Boolean   @default(true)

  // Delivery tracking
  status         BroadcastStatus @default(DRAFT)
  sentAt         DateTime?
  recipientCount Int             @default(0)
  deliveredCount Int             @default(0)
  openedCount    Int             @default(0)
  clickedCount   Int             @default(0)

  // Template
  isTemplate   Boolean @default(false)
  templateName String?

  // Metadata
  createdBy String // Admin user ID
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([scheduledFor])
}

enum BroadcastStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
  CANCELLED
}

// ==================== ADVANCED SEO TRACKING ====================

// Page-level SEO tracking with comprehensive metrics
model Page {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  url         String
  title       String?
  description String?
  canonical   String?

  // Page identification
  pageType PageType @default(OTHER)
  slug     String?
  path     String?

  // Content analysis
  wordCount    Int?
  readingTime  Int? // minutes
  languageCode String @default("en")

  // SEO metadata
  metaTags        String  @default("{}") // JSON string
  openGraphTags   String  @default("{}") // JSON string
  twitterCardTags String  @default("{}") // JSON string
  schemaMarkup    String? // JSON string for structured data

  // Heading structure
  h1Count          Int     @default(0)
  h2Count          Int     @default(0)
  h3Count          Int     @default(0)
  h1Text           String?
  headingStructure String  @default("{}") // JSON string

  // Image analysis
  totalImages      Int    @default(0)
  imagesWithAlt    Int    @default(0)
  missingAltImages String @default("[]") // JSON array

  // Link analysis
  internalLinks Int    @default(0)
  externalLinks Int    @default(0)
  brokenLinks   String @default("[]") // JSON array

  // Technical SEO
  loadTime    Float? // milliseconds
  pageSize    Int? // bytes
  httpStatus  Int?
  isIndexable Boolean @default(true)
  robotsMeta  String?

  // Mobile optimization
  mobileScore  Float? // 0-100
  mobileIssues String @default("[]") // JSON array

  // Core Web Vitals
  lcp  Float? // Largest Contentful Paint (seconds)
  fid  Float? // First Input Delay (milliseconds)
  cls  Float? // Cumulative Layout Shift (score)
  fcp  Float? // First Contentful Paint (seconds)
  ttfb Float? // Time to First Byte (milliseconds)

  // Content quality metrics
  readabilityScore Float? // Flesch Reading Ease
  keywordDensity   String  @default("{}") // JSON object
  contentQuality   String? // 'excellent', 'good', 'needs_improvement'

  // SEO health score
  seoScore       Float? // Overall SEO score 0-100
  scoreBreakdown String @default("{}") // JSON object

  // Analytics data (when available)
  pageViews     Int?
  bounceRate    Float?
  avgTimeOnPage Float? // seconds

  // Status tracking
  lastCrawled  DateTime?
  lastModified DateTime?
  firstSeen    DateTime  @default(now())

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  PageKeyword     PageKeyword[]
  PageImprovement PageImprovement[]
  PageSnapshot    PageSnapshot[]

  @@unique([connectionId, url])
  @@index([connectionId])
  @@index([pageType])
  @@index([seoScore])
  @@index([lastCrawled])
}

enum PageType {
  HOMEPAGE
  PRODUCT
  CATEGORY
  BLOG_POST
  BLOG_INDEX
  LANDING_PAGE
  CHECKOUT
  CART
  ACCOUNT
  CONTACT
  ABOUT
  LEGAL
  OTHER
}

// Keyword tracking and intelligence
model Keyword {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  keyword      String
  searchVolume Int? // Monthly search volume
  difficulty   Float? // 0-100 ranking difficulty
  cpc          Float? // Cost per click in USD
  intent       KeywordIntent?
  category     String? // keyword category/topic

  // Tracking
  isTracking Boolean @default(true)
  priority   Int     @default(5) // 1=highest, 10=lowest

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  rankings KeywordRanking[]
  pages    PageKeyword[]

  @@unique([connectionId, keyword])
  @@index([connectionId])
  @@index([searchVolume])
  @@index([difficulty])
}

enum KeywordIntent {
  INFORMATIONAL
  NAVIGATIONAL
  TRANSACTIONAL
  COMMERCIAL
}

// Keyword rankings over time
model KeywordRanking {
  id        String  @id @default(uuid())
  keywordId String
  keyword   Keyword @relation(fields: [keywordId], references: [id], onDelete: Cascade)

  position     Int // Search result position
  url          String // Ranking URL
  searchEngine String  @default("google") // google, bing, etc.
  location     String? // Geographic location
  device       String  @default("desktop") // desktop, mobile

  // SERP features
  hasFeaturedSnippet Boolean @default(false)
  hasLocalPack       Boolean @default(false)
  hasPeopleAlsoAsk   Boolean @default(false)
  hasImagePack       Boolean @default(false)

  date      DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([keywordId])
  @@index([date])
  @@index([position])
}

// Page-Keyword association (which keywords target which pages)
model PageKeyword {
  id        String  @id @default(uuid())
  pageId    String
  page      Page    @relation(fields: [pageId], references: [id], onDelete: Cascade)
  keywordId String
  keyword   Keyword @relation(fields: [keywordId], references: [id], onDelete: Cascade)

  // How well the page targets this keyword
  relevanceScore Float? // 0-100
  density        Float? // keyword density %
  position       String? // where keyword appears (title, h1, body, etc.)

  isTarget Boolean @default(true) // Is this a target keyword for this page?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([pageId, keywordId])
  @@index([pageId])
  @@index([keywordId])
}

// AI-powered insights and recommendations
model AIInsight {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  pageId String? // Optional - can be site-wide or page-specific

  type        InsightType
  category    String // 'technical', 'content', 'keywords', 'links', 'performance'
  title       String
  description String
  insight     String      @db.Text // AI-generated detailed analysis

  // Actionable recommendations
  recommendation  String  @db.Text
  estimatedImpact Float? // Estimated traffic increase %
  estimatedEffort String? // 'low', 'medium', 'high'

  priority   Priority @default(MEDIUM)
  confidence Float    @default(80) // AI confidence 0-100

  status InsightStatus @default(NEW)

  // Impact tracking (after implementation)
  implementedAt DateTime?
  actualImpact  Float? // Measured traffic change %

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([connectionId])
  @@index([status])
  @@index([priority])
  @@index([type])
}

enum InsightType {
  MISSING_CONTENT
  KEYWORD_OPPORTUNITY
  TECHNICAL_ISSUE
  LINK_BUILDING
  CONTENT_REFRESH
  PERFORMANCE_ISSUE
  COMPETITOR_GAP
  TRENDING_TOPIC
  SEASONAL_OPPORTUNITY
}

enum Priority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum InsightStatus {
  NEW
  REVIEWED
  IN_PROGRESS
  IMPLEMENTED
  DISMISSED
}

// Content optimization suggestions
model ContentSuggestion {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  pageId String // Specific page to optimize

  suggestionType String // 'add_section', 'expand_content', 'add_keywords', 'improve_readability'
  title          String
  description    String @db.Text

  // What to add/change
  suggestedContent String  @db.Text
  targetLocation   String? // Where to add (e.g., "after h2", "in intro")

  // Keywords to target
  targetKeywords String @default("[]") // JSON array

  // Metrics
  currentWordCount   Int?
  suggestedWordCount Int?
  currentReadability Float?
  targetReadability  Float?

  status SuggestionStatus @default(PENDING)

  implementedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([connectionId])
  @@index([pageId])
  @@index([status])
}

enum SuggestionStatus {
  PENDING
  APPROVED
  IMPLEMENTED
  REJECTED
}

// Track page-level improvements and changes
model PageImprovement {
  id     String @id @default(uuid())
  pageId String
  page   Page   @relation(fields: [pageId], references: [id], onDelete: Cascade)

  improvementType String // 'meta_tags', 'content', 'images', 'links', 'technical'
  description     String

  beforeValue String? @db.Text
  afterValue  String? @db.Text

  // Metrics before/after
  seoScoreBefore Float?
  seoScoreAfter  Float?
  rankingBefore  Int?
  rankingAfter   Int?
  trafficBefore  Int?
  trafficAfter   Int?

  implementedAt DateTime  @default(now())
  measuredAt    DateTime?

  createdAt DateTime @default(now())

  @@index([pageId])
  @@index([implementedAt])
}

// Site health scores over time
model SiteHealthScore {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  date DateTime @default(now())

  // Overall scores
  overallScore     Float // 0-100
  technicalScore   Float // 0-100
  contentScore     Float // 0-100
  performanceScore Float // 0-100
  securityScore    Float // 0-100

  // Key metrics
  totalPages     Int
  indexablePages Int
  brokenLinks    Int
  avgLoadTime    Float // seconds
  avgSeoScore    Float // average page SEO score

  // Issues breakdown
  criticalIssues Int
  highIssues     Int
  mediumIssues   Int
  lowIssues      Int

  // Rankings
  avgKeywordPosition Float?
  topKeywordsCount   Int? // Keywords in top 10

  // Traffic (if available)
  organicTraffic Int?
  organicClicks  Int?

  createdAt DateTime @default(now())

  @@unique([connectionId, date])
  @@index([connectionId])
  @@index([date])
  @@index([overallScore])
}

// Page snapshots for comparison over time
model PageSnapshot {
  id     String @id @default(uuid())
  pageId String
  page   Page   @relation(fields: [pageId], references: [id], onDelete: Cascade)

  // Snapshot of key metrics at this point in time
  seoScore   Float?
  wordCount  Int?
  loadTime   Float?
  httpStatus Int?
  lcp        Float?
  fid        Float?
  cls        Float?

  // Content hash to detect changes
  contentHash String?

  date      DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([pageId])
  @@index([date])
}

// Customer Connection Requests (white-glove onboarding)
model ConnectionRequest {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Store details
  platform  Platform // SHOPIFY, WORDPRESS, etc.
  storeUrl  String
  storeName String?
  message   String? // Optional message from customer

  // Request status
  status ConnectionRequestStatus @default(PENDING)

  // OAuth link (generated by admin)
  oauthUrl String?

  // Result
  connectionId    String? // Reference to Connection once created
  rejectionReason String?

  // Admin tracking
  reviewedBy String? // Admin user ID who reviewed
  reviewedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

enum ConnectionRequestStatus {
  PENDING // Customer submitted, awaiting admin review
  APPROVED // Admin approved, OAuth link generated
  LINK_SENT // OAuth link sent to customer
  CONNECTED // Customer authorized and connection created
  REJECTED // Admin rejected request
  EXPIRED // Request expired (after 7 days)
}

// Image Asset Tracking for SEO Optimization
model ImageAsset {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  pageId String? // Optional - which page contains this image

  // Image identification
  url       String
  filename  String?
  format    String? // jpg, png, webp, svg, gif
  sizeBytes Int? // Original file size
  width     Int?
  height    Int?

  // SEO attributes
  altText          String? // Current alt text
  suggestedAltText String? // AI-generated alt text
  title            String?
  caption          String?

  // Optimization status
  status         ImageStatus @default(DETECTED)
  hasAltText     Boolean     @default(false)
  isOptimized    Boolean     @default(false)
  hasLazyLoading Boolean     @default(false)
  isResponsive   Boolean     @default(false)

  // Optimization metrics
  optimizedUrl       String? // CDN or optimized version URL
  optimizedSizeBytes Int? // Size after optimization
  compressionRatio   Float? // Percentage saved
  webpUrl            String? // WebP converted version

  // Technical details
  loadingAttribute String? // 'lazy', 'eager', 'auto'
  srcset           String? // Responsive image sources
  isDecorative     Boolean @default(false) // Decorative images can have empty alt

  // AI analysis
  aiDescription String? // Claude Vision API description
  aiConfidence  Float? // 0-100 confidence in alt text
  aiTags        String  @default("[]") // JSON array of detected tags

  // SEO impact
  impactScore    Float? @default(0) // Estimated SEO impact 0-100
  priority       Int    @default(5) // Optimization priority 1-10
  estimatedValue Float? // Estimated traffic value

  // Context
  context String? // Where/how image is used (hero, product, thumbnail, etc.)
  pageUrl String? // Full URL of the page containing this image

  // Processing
  lastScanned       DateTime?
  lastOptimized     DateTime?
  optimizationError String? // Error message if optimization failed

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([connectionId, url])
  @@index([connectionId])
  @@index([pageId])
  @@index([status])
  @@index([hasAltText])
  @@index([isOptimized])
  @@index([priority])
}

enum ImageStatus {
  DETECTED // Image found, not analyzed
  ANALYZING // AI analyzing for alt text
  NEEDS_ALT_TEXT // Missing alt text
  NEEDS_OPTIMIZATION // Alt text OK, needs compression
  OPTIMIZING // Currently being optimized
  OPTIMIZED // Fully optimized
  FAILED // Optimization failed
  IGNORED // User chose to ignore
}

// Image Optimization Batch Jobs
model ImageOptimizationBatch {
  id           String @id @default(uuid())
  connectionId String

  totalImages     Int
  processedImages Int @default(0)
  optimizedImages Int @default(0)
  failedImages    Int @default(0)
  skippedImages   Int @default(0)

  status   BatchStatus @default(PENDING)
  progress Float       @default(0) // 0-100 percentage

  // Metrics
  totalBytesSaved     Int? // Total bytes saved
  avgCompressionRatio Float? // Average compression %

  // Settings
  settings String @default("{}") // JSON optimization settings

  startedAt           DateTime?
  completedAt         DateTime?
  estimatedCompletion DateTime?

  error String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([connectionId])
  @@index([status])
  @@index([createdAt])
}

enum BatchStatus {
  PENDING
  RUNNING
  PAUSED
  COMPLETED
  FAILED
  CANCELLED
}

// Daily Automation Reports
model DailyReport {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Report metadata
  date          DateTime      @default(now())
  reportType    String        @default("DAILY_AUTOMATION") // DAILY_AUTOMATION, WEEKLY_SUMMARY, etc.
  executionMode ExecutionMode // Mode used during automation

  // Activity summary
  sitesScanned    Int @default(0)
  pagesAnalyzed   Int @default(0)
  issuesFound     Int @default(0)
  issuesFixed     Int @default(0)
  issuesPending   Int @default(0) // For APPROVE mode
  imagesOptimized Int @default(0)

  // Changes made (JSON arrays)
  fixesApplied    String @default("[]") // JSON array of fix details
  pendingApproval String @default("[]") // JSON array of pending fixes (APPROVE mode)
  beforeAfter     String @default("[]") // JSON array of before/after comparisons

  // Impact metrics
  estimatedTrafficImpact Float? // Estimated % traffic increase
  seoScoreChange         Float? // Overall SEO score change
  priorityIssuesResolved Int    @default(0)

  // Delivery status
  emailSent         Boolean   @default(false)
  emailSentAt       DateTime?
  dashboardViewed   Boolean   @default(false)
  dashboardViewedAt DateTime?

  // Report data (detailed JSON)
  reportData String @default("{}") // Full report JSON with all details

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Link to snapshot for rollback
  snapshots AutomationSnapshot[]

  @@index([userId])
  @@index([date])
  @@index([reportType])
  @@index([emailSent])
}

// Intelligent Snapshot System for Complete Rollback
model AutomationSnapshot {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Link to daily report
  reportId String?
  report   DailyReport? @relation(fields: [reportId], references: [id], onDelete: Cascade)

  // Snapshot metadata
  createdAt    DateTime @default(now())
  snapshotType String   @default("DAILY_AUTOMATION") // DAILY_AUTOMATION, MANUAL, BEFORE_MAJOR_CHANGE
  description  String? // e.g., "Daily automation on 2025-01-15 at 09:00 AM"

  // Complete state snapshot (JSON)
  completeState String @db.Text // Full JSON of all changes made in this automation run

  // What was changed - organized by site
  siteSnapshots String @db.Text // JSON array of per-site snapshots

  // Rollback metadata
  canRollback    Boolean   @default(true)
  rollbackExpiry DateTime? // 90 days from creation
  rolledBackAt   DateTime?
  rollbackReason String?

  // Quick stats for UI
  sitesAffected   Int @default(0)
  fixesApplied    Int @default(0)
  imagesOptimized Int @default(0)

  @@index([userId])
  @@index([reportId])
  @@index([createdAt])
  @@index([canRollback])
}

// ==================== SCHEMA.ORG & META TAGS ====================

// Schema.org Structured Data
model StructuredData {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  // Target resource
  resourceType String // 'product', 'collection', 'article', 'page', 'organization'
  resourceId   String? // Shopify product ID, collection ID, etc.
  pageUrl      String? // URL where schema is applied

  // Schema.org type
  schemaType String // 'Product', 'Article', 'Organization', 'BreadcrumbList', 'WebSite', etc.

  // Schema JSON-LD
  schemaJson String @db.Text // Complete JSON-LD structured data

  // Validation
  isValid          Boolean @default(true)
  validationErrors String? @db.Text // JSON array of validation errors

  // Status
  status          StructuredDataStatus @default(DRAFT)
  appliedAt       DateTime?
  lastValidatedAt DateTime?

  // Before/after state for rollback
  beforeState String @default("{}") // JSON string
  afterState  String @default("{}") // JSON string

  // Impact tracking
  impressions Int?   @default(0) // Google Search Console impressions
  clicks      Int?   @default(0) // Google Search Console clicks
  ctr         Float? // Click-through rate

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([connectionId, resourceType, resourceId])
  @@index([connectionId])
  @@index([status])
  @@index([schemaType])
  @@index([pageUrl])
}

enum StructuredDataStatus {
  DRAFT // Generated, not applied
  VALIDATING // Being validated
  VALID // Validated, ready to apply
  INVALID // Validation failed
  APPLIED // Applied to live site
  FAILED // Application failed
  REMOVED // Removed from site
}

// Meta Tags Management
model MetaTag {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  // Target resource
  resourceType String // 'product', 'collection', 'article', 'page'
  resourceId   String? // Shopify product ID, etc.
  pageUrl      String

  // Meta tag types
  title        String?
  description  String?
  keywords     String? // Comma-separated keywords (legacy but still useful)
  canonicalUrl String?
  robots       String? // 'index,follow', 'noindex,nofollow', etc.

  // Open Graph tags (Facebook, LinkedIn)
  ogTitle       String?
  ogDescription String?
  ogImage       String?
  ogType        String? // 'website', 'article', 'product', etc.
  ogUrl         String?

  // Twitter Card tags
  twitterCard        String? // 'summary', 'summary_large_image', 'app', 'player'
  twitterTitle       String?
  twitterDescription String?
  twitterImage       String?
  twitterSite        String? // @username
  twitterCreator     String? // @username

  // Additional meta tags (JSON)
  additionalTags String @default("{}") // JSON object for custom meta tags

  // AI Generation metadata
  aiGenerated  Boolean @default(false)
  aiPrompt     String? @db.Text // Prompt used to generate
  aiConfidence Float? // 0-100 confidence score

  // Status
  status    MetaTagStatus @default(DRAFT)
  appliedAt DateTime?

  // Before/after state for rollback
  beforeState String @default("{}") // JSON string
  afterState  String @default("{}") // JSON string

  // Impact tracking
  impressionsBefore Int?   @default(0)
  impressionsAfter  Int?   @default(0)
  ctrBefore         Float?
  ctrAfter          Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([connectionId, resourceType, resourceId])
  @@index([connectionId])
  @@index([status])
  @@index([pageUrl])
  @@index([aiGenerated])
}

enum MetaTagStatus {
  DRAFT // Generated, not applied
  PENDING // Awaiting approval
  APPROVED // Approved by user
  APPLIED // Applied to live site
  FAILED // Application failed
  ROLLED_BACK // Reverted to previous state
}

// ==================== SHOPIFY-SPECIFIC MODELS ====================

// Shopify Products (for product-level SEO optimization)
model ShopifyProduct {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  // Shopify product identification
  shopifyProductId String // Shopify's product.id (numeric as string)
  shopifyHandle    String // URL-friendly handle

  // Basic product info
  title       String
  bodyHtml    String? @db.Text
  vendor      String?
  productType String?
  tags        String? @db.Text // Comma-separated tags
  status      String // 'active', 'draft', 'archived'

  // SEO fields
  metaTitle       String?
  metaDescription String?

  // Variants and images (stored as JSON for MVP simplicity)
  variants String? @db.Text // JSON array of variants
  images   String? @db.Text // JSON array of images with src, alt, etc.

  // Sales data (for revenue-aware prioritization)
  salesLast30Days Int?    @default(0) // Number of sales in last 30 days
  revenue30Days   Float?  @default(0) // Revenue in last 30 days (USD)
  price           Float? // Current price
  currency        String? @default("USD")

  // Analytics
  pageViews      Int?   @default(0)
  conversionRate Float? // Percentage
  avgTimeOnPage  Float? // Seconds

  // SEO analysis
  lastAnalyzedAt DateTime?
  seoScore       Int?      @default(0) // 0-100
  issuesCount    Int       @default(0)

  // Issues breakdown (JSON for MVP)
  seoIssues String @default("{}") // JSON object with issue types and counts

  // Priority for fixes (calculated based on revenue + SEO issues)
  fixPriority     Int?   @default(5) // 1=highest, 10=lowest
  estimatedImpact Float? // Estimated revenue impact from SEO fixes

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([connectionId, shopifyProductId])
  @@index([connectionId])
  @@index([seoScore])
  @@index([fixPriority])
  @@index([salesLast30Days])
  @@index([lastAnalyzedAt])
}

// Shopify Collections (for collection page optimization)
model ShopifyCollection {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  // Shopify collection identification
  shopifyCollectionId String // Shopify's collection.id
  shopifyHandle       String // URL-friendly handle

  // Basic info
  title        String
  bodyHtml     String? @db.Text
  sortOrder    String? // manual, best-selling, alpha-asc, etc.
  productCount Int     @default(0)

  // SEO fields
  metaTitle       String?
  metaDescription String?

  // Image
  image String? // JSON object with src, alt

  // Analytics
  pageViews      Int?   @default(0)
  conversionRate Float?

  // SEO analysis
  lastAnalyzedAt DateTime?
  seoScore       Int?      @default(0) // 0-100
  issuesCount    Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([connectionId, shopifyCollectionId])
  @@index([connectionId])
  @@index([seoScore])
  @@index([lastAnalyzedAt])
}

// ==================== OPCODE-INSPIRED FEATURES ====================
// Advanced AI agent system, checkpoints, usage analytics, and execution monitoring

// Custom AI Agents - Specialized SEO experts
model SEOAgent {
  id           String @id @default(uuid())
  userId       String
  connectionId String

  // Agent identification
  name        String
  description String @db.Text
  specialty   String // 'title_optimizer', 'meta_description', 'schema_org', 'alt_text', 'custom'
  icon        String? // Icon identifier
  color       String @default("#3b82f6") // Brand color for UI

  // Agent configuration
  systemPrompt String @db.Text // Custom prompt that defines agent behavior
  model        String @default("claude-3-5-sonnet-20241022")
  temperature  Float  @default(0.7)
  maxTokens    Int    @default(2000)

  // Agent type
  isTemplate   Boolean @default(false) // If true, this is a reusable template
  isPublic     Boolean @default(false) // If true, visible in marketplace
  isActive     Boolean @default(true)

  // Performance metrics
  totalRuns           Int   @default(0)
  successfulRuns      Int   @default(0)
  failedRuns          Int   @default(0)
  avgExecutionTime    Float? // Average execution time in seconds
  avgTokensUsed       Int?
  avgCostPerRun       Float? // Average cost in USD

  // User ratings (if public)
  rating        Float? // 0-5 star rating
  ratingCount   Int    @default(0)
  downloads     Int    @default(0) // Times copied by other users

  // Configuration
  targetIssueTypes String @default("[]") // JSON array of issue types this agent handles
  autoApply        Boolean @default(false) // Auto-apply fixes without approval

  // Metadata
  createdBy String? // Original creator if copied from template
  version   String  @default("1.0.0")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  executions AgentExecution[]

  @@index([userId])
  @@index([connectionId])
  @@index([specialty])
  @@index([isTemplate])
  @@index([isPublic])
  @@index([rating])
}

// Agent Execution History - Track every agent run
model AgentExecution {
  id       String   @id @default(uuid())
  agentId  String
  agent    SEOAgent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  userId       String
  connectionId String

  // Execution context
  targetType   String // 'product', 'collection', 'page', 'image', 'batch'
  targetId     String? // Shopify product ID, etc.
  targetUrl    String?
  batchSize    Int     @default(1)

  // Execution status
  status      AgentExecutionStatus @default(PENDING)
  startedAt   DateTime?
  completedAt DateTime?
  duration    Float? // Execution time in seconds

  // Input/Output
  input  String @db.Text // JSON input data
  output String @db.Text // JSON output data
  error  String? @db.Text

  // Claude API metrics
  tokensUsed       Int?
  tokensInput      Int?
  tokensOutput     Int?
  costUSD          Float?
  modelUsed        String?

  // Results
  issuesFound      Int    @default(0)
  fixesGenerated   Int    @default(0)
  fixesApplied     Int    @default(0)
  fixesFailed      Int    @default(0)

  // Quality metrics
  userRating       Int? // 1-5 rating after execution
  userFeedback     String? @db.Text
  wasReverted      Boolean @default(false)
  revertedAt       DateTime?

  createdAt DateTime @default(now())

  @@index([agentId])
  @@index([userId])
  @@index([connectionId])
  @@index([status])
  @@index([startedAt])
  @@index([createdAt])
  // Compound index for agent performance queries
  @@index([agentId, status, completedAt])
}

enum AgentExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  PARTIALLY_COMPLETED
}

// Timeline Checkpoints - Save states for time-travel and rollback
model TimelineCheckpoint {
  id           String @id @default(uuid())
  userId       String
  connectionId String

  // Checkpoint metadata
  name        String
  description String? @db.Text
  type        CheckpointType @default(MANUAL)

  // State snapshot
  completeState String @db.Text // Full JSON snapshot of all data at this point

  // What changed since last checkpoint
  changesSummary String @db.Text // JSON summary of changes
  fixesIncluded  String @default("[]") // JSON array of fix IDs

  // Statistics at checkpoint time
  totalProducts    Int @default(0)
  totalIssues      Int @default(0)
  totalFixes       Int @default(0)
  avgSeoScore      Float?

  // Rollback metadata
  canRollback      Boolean   @default(true)
  rollbackExpiry   DateTime? // 90 days from creation
  rolledBackAt     DateTime?
  rollbackReason   String?
  restoredFromId   String? // If this checkpoint restored from another

  // Branching support
  parentCheckpointId String? // Parent checkpoint in timeline
  branchName         String? // If this starts a new branch

  // Agent execution tracking
  agentExecutionIds String @default("[]") // JSON array of execution IDs

  // Tags for organization
  tags String @default("[]") // JSON array of tags

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([connectionId])
  @@index([type])
  @@index([createdAt])
  @@index([canRollback])
  // Compound index for timeline queries
  @@index([connectionId, createdAt])
}

enum CheckpointType {
  MANUAL // User-created checkpoint
  AUTO_DAILY // Daily automation checkpoint
  PRE_AGENT_RUN // Before agent execution
  POST_AGENT_RUN // After agent execution
  PRE_MAJOR_CHANGE // Before bulk operations
  MILESTONE // Important milestone marker
}

// Usage Analytics - Track Claude API usage with fine granularity
model UsageEvent {
  id           String @id @default(uuid())
  userId       String
  connectionId String?

  // Event identification
  eventType     UsageEventType
  resourceType  String? // 'product', 'collection', 'image', 'agent'
  resourceId    String?

  // Claude API metrics
  model         String
  tokensInput   Int
  tokensOutput  Int
  tokensTotal   Int
  costUSD       Float // Cost in USD

  // Execution context
  executionTime Float? // Milliseconds
  agentId       String? // If executed by agent
  jobId         String? // If part of background job

  // Request details
  requestId     String? // Claude API request ID
  prompt        String? @db.Text // Prompt used (optional, for analysis)
  response      String? @db.Text // Response received (optional)

  // Outcome
  success       Boolean @default(true)
  errorMessage  String?

  // Metadata
  metadata      String  @default("{}") // JSON additional context

  timestamp DateTime @default(now())

  @@index([userId])
  @@index([connectionId])
  @@index([eventType])
  @@index([agentId])
  @@index([timestamp])
  // Compound index for cost analysis queries
  @@index([userId, timestamp])
  @@index([connectionId, timestamp])
}

enum UsageEventType {
  PRODUCT_ANALYSIS // Analyzing a product
  IMAGE_ALT_TEXT // Generating image alt text
  AGENT_EXECUTION // Custom agent run
  CHAT_MESSAGE // AI chat interaction
  BULK_OPTIMIZATION // Batch operations
  SCHEMA_GENERATION // Schema.org generation
  META_TAG_GENERATION // Meta tag generation
  CONTENT_SUGGESTION // Content recommendations
  SEO_AUDIT // Full SEO audit
}

// Usage Budget - Set spending limits and alerts
model UsageBudget {
  id     String @id @default(uuid())
  userId String

  // Budget period
  periodStart DateTime
  periodEnd   DateTime

  // Budget limits
  monthlyLimitUSD Float // Maximum spend per month
  dailyLimitUSD   Float? // Optional daily limit

  // Current usage
  currentSpendUSD Float @default(0)

  // Alert thresholds
  alertAt50Percent  Boolean @default(true)
  alertAt75Percent  Boolean @default(true)
  alertAt90Percent  Boolean @default(true)
  alertAt100Percent Boolean @default(true)

  // Alert status
  alert50Sent  Boolean @default(false)
  alert75Sent  Boolean @default(false)
  alert90Sent  Boolean @default(false)
  alert100Sent Boolean @default(false)

  // Budget status
  isActive     Boolean @default(true)
  pausedAt     DateTime?
  pauseReason  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, periodStart])
  @@index([userId])
  @@index([periodStart])
  @@index([isActive])
}

// Agent Marketplace - Share and discover agents
model AgentMarketplaceListing {
  id      String @id @default(uuid())
  agentId String // Reference to SEOAgent with isPublic=true

  // Listing details
  title       String
  description String @db.Text
  category    String // 'title_optimization', 'meta_tags', 'images', 'schema', 'comprehensive'

  // Media
  thumbnailUrl String?
  screenshots  String @default("[]") // JSON array of screenshot URLs

  // Pricing (future feature)
  isFree      Boolean @default(true)
  price       Float?  // USD

  // Performance showcase
  avgRating           Float?
  totalRatings        Int    @default(0)
  totalInstalls       Int    @default(0)
  avgImprovementScore Float? // Average SEO score improvement

  // Publisher info
  publisherId   String // User ID of publisher
  publisherName String
  verified      Boolean @default(false) // Verified by SEOLOGY team

  // Status
  status        MarketplaceStatus @default(PENDING)
  publishedAt   DateTime?
  rejectedAt    DateTime?
  rejectionReason String?

  // Featured
  isFeatured    Boolean   @default(false)
  featuredUntil DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([status])
  @@index([avgRating])
  @@index([isFeatured])
  @@index([publisherId])
}

enum MarketplaceStatus {
  PENDING // Awaiting review
  APPROVED // Live in marketplace
  REJECTED // Rejected by moderation
  UNLISTED // Publisher unlisted
}

// Agent Reviews - User reviews for marketplace agents
model AgentReview {
  id      String @id @default(uuid())
  agentId String
  userId  String

  // Review content
  rating  Int // 1-5 stars
  title   String?
  review  String? @db.Text

  // Metrics
  wouldRecommend Boolean @default(true)

  // Moderation
  isVisible Boolean @default(true)
  flagged   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([agentId, userId])
  @@index([agentId])
  @@index([userId])
  @@index([rating])
}

// Execution Monitor - Live background job tracking
model ExecutionMonitor {
  id           String @id @default(uuid())
  userId       String
  connectionId String

  // Monitor metadata
  name        String
  description String?
  type        ExecutionMonitorType @default(AUTOMATION)

  // Execution details
  status      MonitorStatus @default(RUNNING)
  startedAt   DateTime      @default(now())
  completedAt DateTime?

  // Progress tracking
  totalTasks      Int   @default(0)
  completedTasks  Int   @default(0)
  failedTasks     Int   @default(0)
  skippedTasks    Int   @default(0)
  progressPercent Float @default(0)

  // Current state
  currentTask     String? // What's being processed now
  currentTaskId   String?
  estimatedTimeRemaining Int? // Seconds

  // Results summary
  issuesFound    Int @default(0)
  fixesGenerated Int @default(0)
  fixesApplied   Int @default(0)

  // Cost tracking
  totalTokensUsed Int    @default(0)
  totalCostUSD    Float  @default(0)

  // Logs (JSON array of log entries)
  logs String @default("[]") // JSON array

  // Error tracking
  errors      String  @default("[]") // JSON array of errors
  errorCount  Int     @default(0)

  // Agent executions in this monitor
  agentExecutionIds String @default("[]") // JSON array

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([connectionId])
  @@index([status])
  @@index([startedAt])
  @@index([type])
}

enum ExecutionMonitorType {
  AUTOMATION // Daily automation
  AGENT_RUN // Single agent execution
  BULK_OPTIMIZATION // Batch processing
  MANUAL_SCAN // User-initiated scan
}

enum MonitorStatus {
  RUNNING
  PAUSED
  COMPLETED
  FAILED
  CANCELLED
}

// Support Tickets - Customer support requests
model SupportTicket {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  userId       String

  name    String
  email   String
  subject String
  message String @db.Text

  status     String  @default("OPEN") // OPEN, IN_PROGRESS, RESOLVED, CLOSED
  assignedTo String?
  resolution String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([connectionId, status])
  @@index([userId, status])
}
