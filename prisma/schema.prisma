// SEOLOGY.AI - Complete Database Schema
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Users & Authentication (managed by Clerk)
model User {
  id      String  @id @default(uuid())
  clerkId String  @unique
  email   String  @unique
  name    String?
  plan    Plan    @default(STARTER)
  role    Role    @default(USER)

  executionMode ExecutionMode @default(AUTOMATIC)

  stripeCustomerId     String?
  stripeSubscriptionId String?

  // Onboarding state
  onboardingCompleted Boolean @default(false)
  onboardingStep      Int     @default(0)
  businessType        String? // E-commerce, SaaS, Local Business
  businessName        String?
  businessStage       String? // Just Starting, Growing, Established
  platform            String? // Shopify, WordPress, WooCommerce, Custom

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  connections        Connection[]
  aiConversations    AIConversation[]
  auditLogs          AuditLog[]
  subscriptions      Subscription[]
  notifications      Notification[]
  webhooks           Webhook[]
  teamMemberships    TeamMember[]
  ownedTeams         Team[]               @relation("TeamOwner")
  sentInvitations    TeamInvitation[]     @relation("InvitationSender")
  usageRecords       UsageRecord[]
  pendingPlans       PendingPlan[]
  connectionRequests ConnectionRequest[] // Customer's connection requests

  @@index([email])
  @@index([plan])
}

enum ExecutionMode {
  AUTOMATIC
  PLAN
  APPROVE
}

enum Role {
  USER
  ADMIN
}

enum Plan {
  STARTER
  GROWTH
  SCALE
}

// Website Connections
model Connection {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  teamId String?
  team   Team?   @relation("TeamConnections", fields: [teamId], references: [id], onDelete: SetNull)

  platform    Platform
  domain      String
  displayName String?

  // Encrypted credentials
  accessToken  String?
  refreshToken String?
  credentials  String? // JSON string of platform-specific data

  status   ConnectionStatus @default(PENDING)
  lastSync DateTime?

  // Health and statistics
  healthStatus   String    @default("unknown") // 'healthy', 'warning', 'error', 'unknown'
  pageCount      Int       @default(0)
  issueCount     Int       @default(0)
  lastCrawlAt    DateTime?
  lastAnalysisAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  issues             Issue[]
  fixes              Fix[]
  metrics            Metric[]
  crawls             Crawl[]
  pages              Page[] // Page-level SEO tracking
  keywords           Keyword[] // Keyword tracking
  aiInsights         AIInsight[] // AI-powered insights
  contentSuggestions ContentSuggestion[] // Content optimization
  healthScores       SiteHealthScore[] // Site health tracking

  @@index([userId])
  @@index([teamId])
  @@index([platform])
  @@index([status])
  @@index([domain])
}

enum Platform {
  SHOPIFY
  WORDPRESS
  WIX
  CUSTOM
}

enum ConnectionStatus {
  PENDING
  CONNECTED
  ERROR
  DISCONNECTED
}

// SEO Issues Detected
model Issue {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  type           String // 'missing_meta', 'broken_link', 'missing_alt', etc.
  title          String
  severity       Severity
  pageUrl        String
  details        String // JSON string
  recommendation String? // AI-generated fix recommendation

  status IssueStatus @default(DETECTED)

  // Impact estimation
  impactScore      Float?  @default(0) // Estimated SEO impact (0-100)
  estimatedTraffic Int? // Estimated traffic impact per month
  elementSelector  String? // CSS selector for element

  detectedAt DateTime  @default(now())
  fixedAt    DateTime?
  createdAt  DateTime  @default(now())

  // Relations
  fixes Fix[]

  @@index([connectionId])
  @@index([status])
  @@index([severity])
  @@index([type])
}

enum Severity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  FIXED
  FAILED
  IGNORED
  DETECTED
  FIXING
}

// Fixes Applied
model Fix {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  issueId String?
  issue   Issue?  @relation(fields: [issueId], references: [id])

  description String
  type        String  @default("seo_fix")
  targetUrl   String?

  changes     String // JSON string of the fix code/changes
  beforeState String @default("{}") // JSON string
  afterState  String @default("{}") // JSON string

  method FixMethod @default(AUTOMATIC)
  status FixStatus @default(PENDING)

  appliedAt        DateTime?
  rolledBackAt     DateTime?
  rollbackDeadline DateTime? // appliedAt + 90 days

  // Impact tracking
  impactMetrics String  @default("{}") // JSON: actual vs. expected metrics
  platform      String? // Platform-specific implementation details

  // Plan association
  planId String?
  plan   PendingPlan? @relation(fields: [planId], references: [id])

  createdAt DateTime @default(now())

  @@index([connectionId])
  @@index([status])
  @@index([appliedAt])
  @@index([rollbackDeadline])
  @@index([planId])
}

enum FixMethod {
  AUTOMATIC
  MANUAL
  PENDING
}

enum FixStatus {
  PENDING
  APPLIED
  ROLLED_BACK
  FAILED
}

// Performance Metrics
model Metric {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  date DateTime @default(now())

  organicTraffic Int?
  rankings       String? // JSON string: {keyword: position}
  pageSpeed      Float?
  issuesCount    Int?
  fixesCount     Int?

  createdAt DateTime @default(now())

  @@unique([connectionId, date])
  @@index([connectionId])
  @@index([date])
}

// AI Conversations
model AIConversation {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  connectionId String?

  messages String // JSON string array of {role, content}
  context  String? // JSON string of site-specific context

  createdAt DateTime @default(now())

  @@index([userId])
}

// Audit Logs
model AuditLog {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  connectionId String?

  action     String
  resource   String? // Type of resource ('fix', 'issue', 'plan', etc.)
  resourceId String? // ID of the resource
  details    String  @default("{}") // JSON string
  ipAddress  String?
  userAgent  String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([action])
  @@index([connectionId])
}

// Billing & Subscriptions
model Subscription {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  stripeSubscriptionId String             @unique
  plan                 Plan
  status               SubscriptionStatus

  currentPeriodStart DateTime
  currentPeriodEnd   DateTime

  trialEnd          DateTime?
  cancelAtPeriodEnd Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  TRIALING
}

// Crawl Jobs
model Crawl {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  status      CrawlStatus @default(PENDING)
  pagesFound  Int?
  issuesFound Int?

  startedAt   DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())

  @@index([connectionId])
  @@index([status])
}

enum CrawlStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

// Notifications
model Notification {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      String // 'SUCCESS', 'ERROR', 'INFO', 'WARNING'
  title     String
  message   String
  actionUrl String? // Optional link to relevant page
  icon      String? // Icon identifier
  color     String? // Color scheme

  read Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

// Webhooks
model Webhook {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  url     String
  events  String // JSON array of event types
  secret  String // HMAC secret for signature verification
  enabled Boolean @default(true)

  failureCount    Int       @default(0)
  lastTriggeredAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([enabled])
}

// Teams & Collaboration
model Team {
  id          String  @id @default(uuid())
  name        String
  description String?

  ownerId String
  owner   User   @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  plan Plan @default(STARTER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members     TeamMember[]
  invitations TeamInvitation[]
  connections Connection[]     @relation("TeamConnections")

  @@index([ownerId])
}

model TeamMember {
  id     String @id @default(uuid())
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  role TeamRole @default(MEMBER)

  joinedAt DateTime @default(now())

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

model TeamInvitation {
  id     String @id @default(uuid())
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  email String
  role  TeamRole @default(MEMBER)

  invitedBy String
  inviter   User   @relation("InvitationSender", fields: [invitedBy], references: [id])

  status InvitationStatus @default(PENDING)
  token  String           @unique

  expiresAt  DateTime
  acceptedAt DateTime?

  createdAt DateTime @default(now())

  @@unique([teamId, email])
  @@index([teamId])
  @@index([email])
  @@index([token])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// CSRF Protection for OAuth Flows
model CSRFToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  provider  String // SHOPIFY, WORDPRESS, GOOGLE
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

// Usage Tracking (Monthly quotas per plan)
model UsageRecord {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  period DateTime // First day of the month (e.g., 2024-01-01)

  // Usage counters
  sitesUsed      Int @default(0)
  fixesApplied   Int @default(0)
  crawlsExecuted Int @default(0)
  apiCallsMade   Int @default(0)

  // Quota limits from plan (cached for historical accuracy)
  sitesLimit Int
  fixesLimit Int

  // Flags
  overageOccurred   Boolean @default(false)
  limitWarningShown Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, period])
  @@index([userId])
  @@index([period])
}

// Job Queue System (for background tasks)
model Job {
  id String @id @default(uuid())

  type     JobType // Type of job to execute
  status   JobStatus @default(PENDING)
  priority Int       @default(5) // 1=highest, 10=lowest

  // Job data
  payload String // JSON string of input data
  result  String? // JSON string of output data
  error   String? // Error message if failed

  // Execution tracking
  attempts            Int       @default(0)
  maxAttempts         Int       @default(3)
  progress            Float     @default(0) // 0-100 percentage
  estimatedCompletion DateTime? // Estimated completion time

  // Scheduling
  scheduledFor DateTime  @default(now())
  startedAt    DateTime?
  completedAt  DateTime?
  failedAt     DateTime?

  // Relations (optional)
  connectionId String?
  userId       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([scheduledFor])
  @@index([priority])
  @@index([type])
  @@index([connectionId])
  @@index([userId])
}

enum JobType {
  CRAWL_SITE
  ANALYZE_SITE
  APPLY_FIX
  ROLLBACK_FIX
  CLEANUP_ROLLBACKS
  RESET_USAGE
  SYNC_METRICS
  GENERATE_REPORT
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  RETRYING
}

// Pending Plans (for PLAN execution mode)
model PendingPlan {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  connectionId String

  // Plan details
  title           String
  description     String
  estimatedImpact String @default("{}") // JSON: expected improvements

  status PlanStatus @default(PENDING)

  // Approval tracking
  approvedAt      DateTime?
  rejectedAt      DateTime?
  executedAt      DateTime?
  rejectionReason String?

  // Relations
  fixes Fix[] // All fixes in this plan

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([connectionId])
  @@index([status])
  @@index([createdAt])
}

enum PlanStatus {
  PENDING
  APPROVED
  REJECTED
  EXECUTING
  COMPLETED
  FAILED
}

// Broadcast Messages (Admin feature)
model Broadcast {
  id String @id @default(uuid())

  // Message content
  type        String // 'INFO', 'SUCCESS', 'WARNING', 'ERROR'
  title       String
  message     String
  richMessage String? // HTML content from rich editor
  actionUrl   String? // Optional CTA link
  actionText  String? // CTA button text

  // Targeting
  targetAudience String @default("all") // 'all', 'plan', 'role', 'custom'
  targetPlans    String @default("[]") // JSON array of plan names
  targetRoles    String @default("[]") // JSON array of roles
  targetUserIds  String @default("[]") // JSON array of specific user IDs

  // Scheduling
  scheduledFor    DateTime?
  sendImmediately Boolean   @default(true)

  // Delivery tracking
  status         BroadcastStatus @default(DRAFT)
  sentAt         DateTime?
  recipientCount Int             @default(0)
  deliveredCount Int             @default(0)
  openedCount    Int             @default(0)
  clickedCount   Int             @default(0)

  // Template
  isTemplate   Boolean @default(false)
  templateName String?

  // Metadata
  createdBy String // Admin user ID
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([scheduledFor])
}

enum BroadcastStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
  CANCELLED
}

// ==================== ADVANCED SEO TRACKING ====================

// Page-level SEO tracking with comprehensive metrics
model Page {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  url         String
  title       String?
  description String?
  canonical   String?

  // Page identification
  pageType PageType @default(OTHER)
  slug     String?
  path     String?

  // Content analysis
  wordCount    Int?
  readingTime  Int? // minutes
  languageCode String @default("en")

  // SEO metadata
  metaTags        String  @default("{}") // JSON string
  openGraphTags   String  @default("{}") // JSON string
  twitterCardTags String  @default("{}") // JSON string
  schemaMarkup    String? // JSON string for structured data

  // Heading structure
  h1Count          Int     @default(0)
  h2Count          Int     @default(0)
  h3Count          Int     @default(0)
  h1Text           String?
  headingStructure String  @default("{}") // JSON string

  // Image analysis
  totalImages      Int    @default(0)
  imagesWithAlt    Int    @default(0)
  missingAltImages String @default("[]") // JSON array

  // Link analysis
  internalLinks Int    @default(0)
  externalLinks Int    @default(0)
  brokenLinks   String @default("[]") // JSON array

  // Technical SEO
  loadTime    Float? // milliseconds
  pageSize    Int? // bytes
  httpStatus  Int?
  isIndexable Boolean @default(true)
  robotsMeta  String?

  // Mobile optimization
  mobileScore  Float? // 0-100
  mobileIssues String @default("[]") // JSON array

  // Core Web Vitals
  lcp  Float? // Largest Contentful Paint (seconds)
  fid  Float? // First Input Delay (milliseconds)
  cls  Float? // Cumulative Layout Shift (score)
  fcp  Float? // First Contentful Paint (seconds)
  ttfb Float? // Time to First Byte (milliseconds)

  // Content quality metrics
  readabilityScore Float? // Flesch Reading Ease
  keywordDensity   String  @default("{}") // JSON object
  contentQuality   String? // 'excellent', 'good', 'needs_improvement'

  // SEO health score
  seoScore       Float? // Overall SEO score 0-100
  scoreBreakdown String @default("{}") // JSON object

  // Analytics data (when available)
  pageViews     Int?
  bounceRate    Float?
  avgTimeOnPage Float? // seconds

  // Status tracking
  lastCrawled  DateTime?
  lastModified DateTime?
  firstSeen    DateTime  @default(now())

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  PageKeyword     PageKeyword[]
  PageImprovement PageImprovement[]
  PageSnapshot    PageSnapshot[]

  @@unique([connectionId, url])
  @@index([connectionId])
  @@index([pageType])
  @@index([seoScore])
  @@index([lastCrawled])
}

enum PageType {
  HOMEPAGE
  PRODUCT
  CATEGORY
  BLOG_POST
  BLOG_INDEX
  LANDING_PAGE
  CHECKOUT
  CART
  ACCOUNT
  CONTACT
  ABOUT
  LEGAL
  OTHER
}

// Keyword tracking and intelligence
model Keyword {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  keyword      String
  searchVolume Int? // Monthly search volume
  difficulty   Float? // 0-100 ranking difficulty
  cpc          Float? // Cost per click in USD
  intent       KeywordIntent?
  category     String? // keyword category/topic

  // Tracking
  isTracking Boolean @default(true)
  priority   Int     @default(5) // 1=highest, 10=lowest

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  rankings KeywordRanking[]
  pages    PageKeyword[]

  @@unique([connectionId, keyword])
  @@index([connectionId])
  @@index([searchVolume])
  @@index([difficulty])
}

enum KeywordIntent {
  INFORMATIONAL
  NAVIGATIONAL
  TRANSACTIONAL
  COMMERCIAL
}

// Keyword rankings over time
model KeywordRanking {
  id        String  @id @default(uuid())
  keywordId String
  keyword   Keyword @relation(fields: [keywordId], references: [id], onDelete: Cascade)

  position     Int // Search result position
  url          String // Ranking URL
  searchEngine String  @default("google") // google, bing, etc.
  location     String? // Geographic location
  device       String  @default("desktop") // desktop, mobile

  // SERP features
  hasFeaturedSnippet Boolean @default(false)
  hasLocalPack       Boolean @default(false)
  hasPeopleAlsoAsk   Boolean @default(false)
  hasImagePack       Boolean @default(false)

  date      DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([keywordId])
  @@index([date])
  @@index([position])
}

// Page-Keyword association (which keywords target which pages)
model PageKeyword {
  id        String  @id @default(uuid())
  pageId    String
  page      Page    @relation(fields: [pageId], references: [id], onDelete: Cascade)
  keywordId String
  keyword   Keyword @relation(fields: [keywordId], references: [id], onDelete: Cascade)

  // How well the page targets this keyword
  relevanceScore Float? // 0-100
  density        Float? // keyword density %
  position       String? // where keyword appears (title, h1, body, etc.)

  isTarget Boolean @default(true) // Is this a target keyword for this page?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([pageId, keywordId])
  @@index([pageId])
  @@index([keywordId])
}

// AI-powered insights and recommendations
model AIInsight {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  pageId String? // Optional - can be site-wide or page-specific

  type        InsightType
  category    String // 'technical', 'content', 'keywords', 'links', 'performance'
  title       String
  description String
  insight     String      @db.Text // AI-generated detailed analysis

  // Actionable recommendations
  recommendation  String  @db.Text
  estimatedImpact Float? // Estimated traffic increase %
  estimatedEffort String? // 'low', 'medium', 'high'

  priority   Priority @default(MEDIUM)
  confidence Float    @default(80) // AI confidence 0-100

  status InsightStatus @default(NEW)

  // Impact tracking (after implementation)
  implementedAt DateTime?
  actualImpact  Float? // Measured traffic change %

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([connectionId])
  @@index([status])
  @@index([priority])
  @@index([type])
}

enum InsightType {
  MISSING_CONTENT
  KEYWORD_OPPORTUNITY
  TECHNICAL_ISSUE
  LINK_BUILDING
  CONTENT_REFRESH
  PERFORMANCE_ISSUE
  COMPETITOR_GAP
  TRENDING_TOPIC
  SEASONAL_OPPORTUNITY
}

enum Priority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum InsightStatus {
  NEW
  REVIEWED
  IN_PROGRESS
  IMPLEMENTED
  DISMISSED
}

// Content optimization suggestions
model ContentSuggestion {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  pageId String // Specific page to optimize

  suggestionType String // 'add_section', 'expand_content', 'add_keywords', 'improve_readability'
  title          String
  description    String @db.Text

  // What to add/change
  suggestedContent String  @db.Text
  targetLocation   String? // Where to add (e.g., "after h2", "in intro")

  // Keywords to target
  targetKeywords String @default("[]") // JSON array

  // Metrics
  currentWordCount   Int?
  suggestedWordCount Int?
  currentReadability Float?
  targetReadability  Float?

  status SuggestionStatus @default(PENDING)

  implementedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([connectionId])
  @@index([pageId])
  @@index([status])
}

enum SuggestionStatus {
  PENDING
  APPROVED
  IMPLEMENTED
  REJECTED
}

// Track page-level improvements and changes
model PageImprovement {
  id     String @id @default(uuid())
  pageId String
  page   Page   @relation(fields: [pageId], references: [id], onDelete: Cascade)

  improvementType String // 'meta_tags', 'content', 'images', 'links', 'technical'
  description     String

  beforeValue String? @db.Text
  afterValue  String? @db.Text

  // Metrics before/after
  seoScoreBefore Float?
  seoScoreAfter  Float?
  rankingBefore  Int?
  rankingAfter   Int?
  trafficBefore  Int?
  trafficAfter   Int?

  implementedAt DateTime  @default(now())
  measuredAt    DateTime?

  createdAt DateTime @default(now())

  @@index([pageId])
  @@index([implementedAt])
}

// Site health scores over time
model SiteHealthScore {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  date DateTime @default(now())

  // Overall scores
  overallScore     Float // 0-100
  technicalScore   Float // 0-100
  contentScore     Float // 0-100
  performanceScore Float // 0-100
  securityScore    Float // 0-100

  // Key metrics
  totalPages     Int
  indexablePages Int
  brokenLinks    Int
  avgLoadTime    Float // seconds
  avgSeoScore    Float // average page SEO score

  // Issues breakdown
  criticalIssues Int
  highIssues     Int
  mediumIssues   Int
  lowIssues      Int

  // Rankings
  avgKeywordPosition Float?
  topKeywordsCount   Int? // Keywords in top 10

  // Traffic (if available)
  organicTraffic Int?
  organicClicks  Int?

  createdAt DateTime @default(now())

  @@unique([connectionId, date])
  @@index([connectionId])
  @@index([date])
  @@index([overallScore])
}

// Page snapshots for comparison over time
model PageSnapshot {
  id     String @id @default(uuid())
  pageId String
  page   Page   @relation(fields: [pageId], references: [id], onDelete: Cascade)

  // Snapshot of key metrics at this point in time
  seoScore   Float?
  wordCount  Int?
  loadTime   Float?
  httpStatus Int?
  lcp        Float?
  fid        Float?
  cls        Float?

  // Content hash to detect changes
  contentHash String?

  date      DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([pageId])
  @@index([date])
}

// Customer Connection Requests (white-glove onboarding)
model ConnectionRequest {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Store details
  platform   Platform // SHOPIFY, WORDPRESS, etc.
  storeUrl   String
  storeName  String?
  message    String? // Optional message from customer

  // Request status
  status ConnectionRequestStatus @default(PENDING)

  // OAuth link (generated by admin)
  oauthUrl String?

  // Result
  connectionId String? // Reference to Connection once created
  rejectionReason String?

  // Admin tracking
  reviewedBy String? // Admin user ID who reviewed
  reviewedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

enum ConnectionRequestStatus {
  PENDING     // Customer submitted, awaiting admin review
  APPROVED    // Admin approved, OAuth link generated
  LINK_SENT   // OAuth link sent to customer
  CONNECTED   // Customer authorized and connection created
  REJECTED    // Admin rejected request
  EXPIRED     // Request expired (after 7 days)
}

// Add ConnectionRequest relation to User
// (Already handled by the relation above)
