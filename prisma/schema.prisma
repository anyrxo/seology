// SEOLOGY.AI - Complete Database Schema
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Users & Authentication (managed by Clerk)
model User {
  id      String  @id @default(uuid())
  clerkId String  @unique
  email   String  @unique
  name    String?
  plan    Plan    @default(STARTER)
  role    Role    @default(USER)

  executionMode ExecutionMode @default(AUTOMATIC)

  stripeCustomerId     String?
  stripeSubscriptionId String?

  // Onboarding state
  onboardingCompleted Boolean @default(false)
  onboardingStep      Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  connections     Connection[]
  aiConversations AIConversation[]
  auditLogs       AuditLog[]
  subscriptions   Subscription[]
  notifications   Notification[]
  webhooks        Webhook[]
  teamMemberships TeamMember[]
  ownedTeams      Team[]           @relation("TeamOwner")
  sentInvitations TeamInvitation[] @relation("InvitationSender")
  usageRecords    UsageRecord[]
  pendingPlans    PendingPlan[]

  @@index([email])
  @@index([plan])
}

enum ExecutionMode {
  AUTOMATIC
  PLAN
  APPROVE
}

enum Role {
  USER
  ADMIN
}

enum Plan {
  STARTER
  GROWTH
  SCALE
}

// Website Connections
model Connection {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  teamId String?
  team   Team?   @relation("TeamConnections", fields: [teamId], references: [id], onDelete: SetNull)

  platform    Platform
  domain      String
  displayName String?

  // Encrypted credentials
  accessToken  String?
  refreshToken String?
  credentials  String? // JSON string of platform-specific data

  status   ConnectionStatus @default(PENDING)
  lastSync DateTime?

  // Health and statistics
  healthStatus String  @default("unknown") // 'healthy', 'warning', 'error', 'unknown'
  pageCount    Int     @default(0)
  issueCount   Int     @default(0)
  lastCrawlAt  DateTime?
  lastAnalysisAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  issues  Issue[]
  fixes   Fix[]
  metrics Metric[]
  crawls  Crawl[]

  @@index([userId])
  @@index([teamId])
  @@index([platform])
  @@index([status])
  @@index([domain])
}

enum Platform {
  SHOPIFY
  WORDPRESS
  WIX
  CUSTOM
}

enum ConnectionStatus {
  PENDING
  CONNECTED
  ERROR
  DISCONNECTED
}

// SEO Issues Detected
model Issue {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  type           String // 'missing_meta', 'broken_link', 'missing_alt', etc.
  title          String
  severity       Severity
  pageUrl        String
  details        String // JSON string
  recommendation String? // AI-generated fix recommendation

  status IssueStatus @default(DETECTED)

  // Impact estimation
  impactScore        Float?   @default(0) // Estimated SEO impact (0-100)
  estimatedTraffic   Int?     // Estimated traffic impact per month
  elementSelector    String?  // CSS selector for element

  detectedAt DateTime  @default(now())
  fixedAt    DateTime?
  createdAt  DateTime  @default(now())

  // Relations
  fixes Fix[]

  @@index([connectionId])
  @@index([status])
  @@index([severity])
  @@index([type])
}

enum Severity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  FIXED
  FAILED
  IGNORED
  DETECTED
  FIXING
}

// Fixes Applied
model Fix {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  issueId String?
  issue   Issue?  @relation(fields: [issueId], references: [id])

  description String
  type        String  @default("seo_fix")
  targetUrl   String?

  changes     String // JSON string of the fix code/changes
  beforeState String @default("{}") // JSON string
  afterState  String @default("{}") // JSON string

  method FixMethod @default(AUTOMATIC)
  status FixStatus @default(PENDING)

  appliedAt    DateTime?
  rolledBackAt DateTime?
  rollbackDeadline DateTime? // appliedAt + 90 days

  // Impact tracking
  impactMetrics String @default("{}") // JSON: actual vs. expected metrics
  platform      String? // Platform-specific implementation details

  // Plan association
  planId String?
  plan   PendingPlan? @relation(fields: [planId], references: [id])

  createdAt DateTime @default(now())

  @@index([connectionId])
  @@index([status])
  @@index([appliedAt])
  @@index([rollbackDeadline])
  @@index([planId])
}

enum FixMethod {
  AUTOMATIC
  MANUAL
  PENDING
}

enum FixStatus {
  PENDING
  APPLIED
  ROLLED_BACK
  FAILED
}

// Performance Metrics
model Metric {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  date DateTime @default(now())

  organicTraffic Int?
  rankings       String? // JSON string: {keyword: position}
  pageSpeed      Float?
  issuesCount    Int?
  fixesCount     Int?

  createdAt DateTime @default(now())

  @@unique([connectionId, date])
  @@index([connectionId])
  @@index([date])
}

// AI Conversations
model AIConversation {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  connectionId String?

  messages String // JSON string array of {role, content}
  context  String? // JSON string of site-specific context

  createdAt DateTime @default(now())

  @@index([userId])
}

// Audit Logs
model AuditLog {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  connectionId String?

  action     String
  resource   String? // Type of resource ('fix', 'issue', 'plan', etc.)
  resourceId String? // ID of the resource
  details    String  @default("{}") // JSON string
  ipAddress  String?
  userAgent  String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([action])
  @@index([connectionId])
}

// Billing & Subscriptions
model Subscription {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  stripeSubscriptionId String             @unique
  plan                 Plan
  status               SubscriptionStatus

  currentPeriodStart DateTime
  currentPeriodEnd   DateTime

  trialEnd DateTime?
  cancelAtPeriodEnd Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  TRIALING
}

// Crawl Jobs
model Crawl {
  id           String     @id @default(uuid())
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  status      CrawlStatus @default(PENDING)
  pagesFound  Int?
  issuesFound Int?

  startedAt   DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())

  @@index([connectionId])
  @@index([status])
}

enum CrawlStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

// Notifications
model Notification {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      String // 'SUCCESS', 'ERROR', 'INFO', 'WARNING'
  title     String
  message   String
  actionUrl String? // Optional link to relevant page
  icon      String? // Icon identifier
  color     String? // Color scheme

  read Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

// Webhooks
model Webhook {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  url     String
  events  String // JSON array of event types
  secret  String // HMAC secret for signature verification
  enabled Boolean @default(true)

  failureCount    Int       @default(0)
  lastTriggeredAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([enabled])
}

// Teams & Collaboration
model Team {
  id          String  @id @default(uuid())
  name        String
  description String?

  ownerId String
  owner   User   @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  plan Plan @default(STARTER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members     TeamMember[]
  invitations TeamInvitation[]
  connections Connection[]     @relation("TeamConnections")

  @@index([ownerId])
}

model TeamMember {
  id     String @id @default(uuid())
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  role TeamRole @default(MEMBER)

  joinedAt DateTime @default(now())

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

model TeamInvitation {
  id     String @id @default(uuid())
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  email String
  role  TeamRole @default(MEMBER)

  invitedBy String
  inviter   User   @relation("InvitationSender", fields: [invitedBy], references: [id])

  status InvitationStatus @default(PENDING)
  token  String           @unique

  expiresAt  DateTime
  acceptedAt DateTime?

  createdAt DateTime @default(now())

  @@unique([teamId, email])
  @@index([teamId])
  @@index([email])
  @@index([token])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// CSRF Protection for OAuth Flows
model CSRFToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  provider  String   // SHOPIFY, WORDPRESS, GOOGLE
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

// Usage Tracking (Monthly quotas per plan)
model UsageRecord {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  period DateTime // First day of the month (e.g., 2024-01-01)

  // Usage counters
  sitesUsed Int @default(0)
  fixesApplied Int @default(0)
  crawlsExecuted Int @default(0)
  apiCallsMade Int @default(0)

  // Quota limits from plan (cached for historical accuracy)
  sitesLimit Int
  fixesLimit Int

  // Flags
  overageOccurred Boolean @default(false)
  limitWarningShown Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, period])
  @@index([userId])
  @@index([period])
}

// Job Queue System (for background tasks)
model Job {
  id String @id @default(uuid())

  type JobType // Type of job to execute
  status JobStatus @default(PENDING)
  priority Int @default(5) // 1=highest, 10=lowest

  // Job data
  payload String // JSON string of input data
  result String? // JSON string of output data
  error String? // Error message if failed

  // Execution tracking
  attempts Int @default(0)
  maxAttempts Int @default(3)
  progress Float @default(0) // 0-100 percentage
  estimatedCompletion DateTime? // Estimated completion time

  // Scheduling
  scheduledFor DateTime @default(now())
  startedAt DateTime?
  completedAt DateTime?
  failedAt DateTime?

  // Relations (optional)
  connectionId String?
  userId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([scheduledFor])
  @@index([priority])
  @@index([type])
  @@index([connectionId])
  @@index([userId])
}

enum JobType {
  CRAWL_SITE
  ANALYZE_SITE
  APPLY_FIX
  ROLLBACK_FIX
  CLEANUP_ROLLBACKS
  RESET_USAGE
  SYNC_METRICS
  GENERATE_REPORT
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  RETRYING
}

// Pending Plans (for PLAN execution mode)
model PendingPlan {
  id String @id @default(uuid())

  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  connectionId String

  // Plan details
  title String
  description String
  estimatedImpact String @default("{}") // JSON: expected improvements

  status PlanStatus @default(PENDING)

  // Approval tracking
  approvedAt DateTime?
  rejectedAt DateTime?
  executedAt DateTime?
  rejectionReason String?

  // Relations
  fixes Fix[] // All fixes in this plan

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([connectionId])
  @@index([status])
  @@index([createdAt])
}

enum PlanStatus {
  PENDING
  APPROVED
  REJECTED
  EXECUTING
  COMPLETED
  FAILED
}
